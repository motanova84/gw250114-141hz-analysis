name: Dependency Health Check

on:
  schedule:
    # Run weekly on Wednesday at 10:00 UTC
    - cron: '0 10 * * 3'
  workflow_dispatch:
  pull_request:
    paths:
      - 'requirements.txt'

jobs:
  check-dependencies:
    name: Check Dependency Health
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit safety
          pip install -r requirements.txt
      
      - name: Check for security vulnerabilities with pip-audit
        id: pip_audit
        run: |
          pip-audit --desc --format json > pip_audit_report.json || true
          if [ -s pip_audit_report.json ]; then
            echo "vulnerabilities_found=true" >> $GITHUB_OUTPUT
            cat pip_audit_report.json
          else
            echo "vulnerabilities_found=false" >> $GITHUB_OUTPUT
            echo "No vulnerabilities found"
          fi
        continue-on-error: true
      
      - name: Check for outdated packages
        id: outdated
        run: |
          pip list --outdated --format json > outdated_packages.json
          if [ -s outdated_packages.json ] && [ "$(cat outdated_packages.json)" != "[]" ]; then
            echo "outdated_found=true" >> $GITHUB_OUTPUT
            echo "## Paquetes Desactualizados" >> outdated_report.md
            echo "" >> outdated_report.md
            python3 << 'PYTHON'
          import json
          with open('outdated_packages.json') as f:
              packages = json.load(f)
          for pkg in packages:
              print(f"- **{pkg['name']}**: {pkg['version']} â†’ {pkg['latest_version']}")
          PYTHON
          else
            echo "outdated_found=false" >> $GITHUB_OUTPUT
            echo "All packages are up to date"
          fi
      
      - name: Check Python 3.11 and 3.12 compatibility
        id: compatibility
        run: |
          echo "## Compatibilidad de Python" > compatibility_report.md
          echo "" >> compatibility_report.md
          
          # Test with Python 3.11
          echo "### Python 3.11" >> compatibility_report.md
          python3 --version >> compatibility_report.md
          echo "âœ… InstalaciÃ³n exitosa" >> compatibility_report.md
          echo "" >> compatibility_report.md
        continue-on-error: true
      
      - name: Test with Python 3.12
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
        continue-on-error: true
      
      - name: Install deps with Python 3.12
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          echo "### Python 3.12" >> compatibility_report.md
          python3 --version >> compatibility_report.md
          echo "âœ… InstalaciÃ³n exitosa" >> compatibility_report.md
        continue-on-error: true
      
      - name: Generate health report
        run: |
          cat > dependency_health_report.md << 'EOF'
          # ðŸ¥ Reporte de Salud de Dependencias
          
          *Generado automÃ¡ticamente: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*
          
          ## Resumen
          
          EOF
          
          if [ "${{ steps.pip_audit.outputs.vulnerabilities_found }}" == "true" ]; then
            echo "âš ï¸ **Vulnerabilidades detectadas** - Revisar inmediatamente" >> dependency_health_report.md
          else
            echo "âœ… **Sin vulnerabilidades conocidas**" >> dependency_health_report.md
          fi
          
          echo "" >> dependency_health_report.md
          
          if [ "${{ steps.outdated.outputs.outdated_found }}" == "true" ]; then
            echo "ðŸ“¦ **Paquetes desactualizados disponibles**" >> dependency_health_report.md
            if [ -f outdated_report.md ]; then
              cat outdated_report.md >> dependency_health_report.md
            fi
          else
            echo "âœ… **Todas las dependencias estÃ¡n actualizadas**" >> dependency_health_report.md
          fi
          
          echo "" >> dependency_health_report.md
          
          if [ -f compatibility_report.md ]; then
            cat compatibility_report.md >> dependency_health_report.md
          fi
          
          echo "" >> dependency_health_report.md
          echo "## Recomendaciones" >> dependency_health_report.md
          echo "" >> dependency_health_report.md
          echo "- Revisar vulnerabilidades crÃ­ticas inmediatamente" >> dependency_health_report.md
          echo "- Considerar actualizar paquetes desactualizados" >> dependency_health_report.md
          echo "- Mantener compatibilidad con Python 3.11 y 3.12" >> dependency_health_report.md
          echo "- Seguir las instrucciones en \`.github/copilot-instructions.md\`" >> dependency_health_report.md
          
          cat dependency_health_report.md
      
      - name: Upload health report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-health-report-${{ github.run_number }}
          path: |
            dependency_health_report.md
            pip_audit_report.json
            outdated_packages.json
          retention-days: 30
      
      - name: Create issue if vulnerabilities found
        if: steps.pip_audit.outputs.vulnerabilities_found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Check for existing issue
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security,dependencies'
            });
            
            const existingIssue = issues.find(issue => 
              issue.title.includes('Vulnerabilidades en dependencias')
            );
            
            if (!existingIssue) {
              let reportContent = '';
              if (fs.existsSync('pip_audit_report.json')) {
                const report = JSON.parse(fs.readFileSync('pip_audit_report.json', 'utf8'));
                reportContent = JSON.stringify(report, null, 2);
              }
              
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ðŸ”’ Vulnerabilidades en dependencias detectadas',
                body: `## Alerta de Seguridad AutomÃ¡tica\n\n` +
                      `Se han detectado vulnerabilidades en las dependencias del proyecto.\n\n` +
                      `**AcciÃ³n requerida:**\n` +
                      `- Revisar el reporte de pip-audit\n` +
                      `- Actualizar paquetes vulnerables\n` +
                      `- Verificar compatibilidad despuÃ©s de actualizar\n` +
                      `- Ejecutar tests completos\n\n` +
                      `**Reporte de pip-audit:**\n` +
                      `\`\`\`json\n${reportContent.substring(0, 4000)}\n\`\`\`\n\n` +
                      `**Enlaces Ãºtiles:**\n` +
                      `- [Ver artifacts](../../actions/runs/${context.runId})\n` +
                      `- [GuÃ­a de actualizaciÃ³n](../blob/main/.github/copilot-instructions.md#dependency-management)\n\n` +
                      `*Este issue fue creado automÃ¡ticamente por el bot de salud de dependencias.*`,
                labels: ['security', 'dependencies', 'automated', 'priority: high']
              });
            }
      
      - name: Add to summary
        if: always()
        run: |
          if [ -f dependency_health_report.md ]; then
            cat dependency_health_report.md >> $GITHUB_STEP_SUMMARY
          fi
