name: Tests - Python Matrix

on:
  push:
    branches: [ main, develop, copilot/** ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test-matrix:
    name: Test Python ${{ matrix.python-version }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        python-version: ['3.11', '3.12']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            ENV.lock
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov flake8
      
      - name: Lint with flake8
        run: |
          # Stop the build if there are Python syntax errors or undefined names
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # Exit-zero treats all errors as warnings (max-line-length 120, max-complexity 10)
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=120 --statistics
      
      - name: Security check - No tokens in repository
        run: |
          python tests/test_security_no_tokens.py
      
      - name: Run unit tests
        run: |
          pytest tests/ -v --cov=. --cov-report=xml --cov-report=term
        continue-on-error: false
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-${{ matrix.python-version }}
          fail_ci_if_error: false
      
      - name: Upload test results as artifacts
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: test-results-py${{ matrix.python-version }}-${{ matrix.os }}
          path: |
            results/**/*.json
            results/**/*.png
            coverage.xml
            .coverage
          retention-days: 30
          if-no-files-found: ignore

  test-gpu-optional:
    name: Test with GPU (Optional)
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || contains(github.event.head_commit.message, '[test-gpu]')
    continue-on-error: true  # Don't fail workflow if GPU not available
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check for GPU availability
        id: check-gpu
        run: |
          if command -v nvidia-smi &> /dev/null; then
            echo "gpu_available=true" >> $GITHUB_OUTPUT
            nvidia-smi
          else
            echo "gpu_available=false" >> $GITHUB_OUTPUT
            echo "::warning::GPU not available, skipping GPU tests"
          fi
      
      - name: Set up Python 3.11
        if: steps.check-gpu.outputs.gpu_available == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies with GPU support
        if: steps.check-gpu.outputs.gpu_available == 'true'
        run: |
          python -m pip install --upgrade pip
          pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121
          pip install -r requirements.txt
          pip install pytest
      
      - name: Run GPU tests
        if: steps.check-gpu.outputs.gpu_available == 'true'
        run: |
          pytest tests/ -v -k "gpu or cuda" --tb=short
      
      - name: Upload GPU test results
        if: steps.check-gpu.outputs.gpu_available == 'true'
        uses: actions/upload-artifact@v5
        with:
          name: gpu-test-results
          path: results/**/*.json
          retention-days: 7

  lean-verification:
    name: Lean 4 Formal Verification
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Lean 4
        run: |
          curl https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh -sSf | sh -s -- -y --default-toolchain leanprover/lean4:v4.3.0
          echo "$HOME/.elan/bin" >> $GITHUB_PATH
      
      - name: Verify Lean installation
        run: |
          lean --version
          lake --version
      
      - name: Build Lean project
        working-directory: formalization
        run: |
          lake update
          lake build
      
      - name: Run Lean tests
        working-directory: formalization
        run: |
          lake test
        continue-on-error: true
      
      - name: Generate build info
        run: |
          mkdir -p formalization
          echo "# Lean Build Status" > formalization/STATUS.md
          echo "" >> formalization/STATUS.md
          echo "**Build Date**: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> formalization/STATUS.md
          echo "**Lean Version**: $(lean --version)" >> formalization/STATUS.md
          echo "**Build Hash**: $(git rev-parse HEAD)" >> formalization/STATUS.md
          echo "**Branch**: ${{ github.ref_name }}" >> formalization/STATUS.md
          echo "" >> formalization/STATUS.md
          if [ -f formalization/lake-manifest.json ]; then
            echo "**mathlib4 Version**: $(jq -r '.packages[] | select(.name=="mathlib4") | .rev' formalization/lake-manifest.json 2>/dev/null || echo "unknown")" >> formalization/STATUS.md
          fi
      
      - name: Upload Lean build artifacts
        uses: actions/upload-artifact@v5
        with:
          name: lean-build
          path: |
            formalization/.lake/
            formalization/STATUS.md
          retention-days: 7

  docker-build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    needs: [test-matrix, lean-verification]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract metadata for Docker (CPU)
        id: meta-cpu
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest,enable={{is_default_branch}}
      
      - name: Build and push CPU image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta-cpu.outputs.tags }}
          labels: ${{ steps.meta-cpu.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Extract metadata for Docker (GPU)
        id: meta-gpu
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=ref,event=branch,suffix=-gpu
            type=semver,pattern={{version}},suffix=-gpu
            type=semver,pattern={{major}}.{{minor}},suffix=-gpu
            type=raw,value=latest-gpu,enable={{is_default_branch}}
      
      - name: Build and push GPU image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile.gpu
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta-gpu.outputs.tags }}
          labels: ${{ steps.meta-gpu.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Generate Docker image hashes
        run: |
          echo "# Docker Image Hashes - $(date +%Y-%m-%d)" > docker-hashes.txt
          echo "" >> docker-hashes.txt
          echo "## CPU Image" >> docker-hashes.txt
          docker pull ghcr.io/${{ github.repository }}:latest || echo "Image not yet available"
          docker inspect ghcr.io/${{ github.repository }}:latest --format='{{.Id}}' >> docker-hashes.txt || echo "N/A" >> docker-hashes.txt
          echo "" >> docker-hashes.txt
          echo "## GPU Image" >> docker-hashes.txt
          docker pull ghcr.io/${{ github.repository }}:latest-gpu || echo "Image not yet available"
          docker inspect ghcr.io/${{ github.repository }}:latest-gpu --format='{{.Id}}' >> docker-hashes.txt || echo "N/A" >> docker-hashes.txt
      
      - name: Upload Docker hashes
        uses: actions/upload-artifact@v5
        with:
          name: docker-hashes
          path: docker-hashes.txt
          retention-days: 90

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test-matrix, lean-verification]
    if: always()
    
    steps:
      - name: Check test results
        run: |
          echo "## Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Python Tests | ${{ needs.test-matrix.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Lean Verification | ${{ needs.lean-verification.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow**: ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
