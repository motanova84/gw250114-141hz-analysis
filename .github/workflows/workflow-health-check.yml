name: Workflow Health Check

on:
  workflow_dispatch:
  schedule:
    # Run daily at 08:00 UTC
    - cron: '0 8 * * *'

jobs:
  check-workflow-health:
    name: Check All Workflows Status
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
      
      - name: Check recent workflow runs
        uses: actions/github-script@v7
        id: check_workflows
        with:
          script: |
            const workflows = [
              'quantum-validations.yml',
              'alternative-validations.yml',
              'multi-event-analysis.yml',
              'detector-analysis.yml',
              'scientific-validation.yml',
              'advanced-analysis.yml',
              'special-analysis.yml',
              'comprehensive-testing.yml',
              'analyze.yml',
              'production-qcal.yml'
            ];
            
            let allGreen = true;
            let summary = '## ðŸ¥ Workflow Health Report\n\n';
            summary += '**Generated:** ' + new Date().toISOString() + '\n\n';
            summary += '### Workflow Status\n\n';
            
            for (const workflow of workflows) {
              try {
                const runs = await github.rest.actions.listWorkflowRuns({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  workflow_id: workflow,
                  per_page: 1
                });
                
                if (runs.data.workflow_runs.length > 0) {
                  const lastRun = runs.data.workflow_runs[0];
                  const status = lastRun.conclusion;
                  const icon = status === 'success' ? 'âœ…' : status === 'failure' ? 'âŒ' : 'âš ï¸';
                  summary += `- ${icon} **${workflow}**: ${status || 'in_progress'} (${lastRun.created_at})\n`;
                  
                  if (status !== 'success' && status !== null) {
                    allGreen = false;
                  }
                } else {
                  summary += `- âšª **${workflow}**: No runs found\n`;
                }
              } catch (error) {
                summary += `- â“ **${workflow}**: Error checking status\n`;
              }
            }
            
            summary += '\n### Overall Status\n\n';
            if (allGreen) {
              summary += 'ðŸŸ¢ **ALL WORKFLOWS GREEN** - System is healthy!\n';
            } else {
              summary += 'ðŸ”´ **SOME WORKFLOWS NEED ATTENTION** - Review failed workflows.\n';
            }
            
            core.summary.addRaw(summary);
            await core.summary.write();
            
            return { allGreen };
      
      - name: Report status
        run: |
          if [ "${{ steps.check_workflows.outputs.allGreen }}" == "true" ]; then
            echo "âœ… All workflows are green!"
            exit 0
          else
            echo "âš ï¸ Some workflows need attention"
            exit 0
          fi
  
  check-dependencies:
    name: Check Dependencies Health
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: List installed packages
        run: |
          pip list --format=json > installed_packages.json
          echo "## ðŸ“¦ Installed Packages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          pip list >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
      
      - name: Check for security vulnerabilities
        run: |
          pip install pip-audit
          pip-audit --desc || echo "Some vulnerabilities found"
        continue-on-error: true
  
  system-status:
    name: System Status Summary
    needs: [check-workflow-health, check-dependencies]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Generate system status
        run: |
          echo "## ðŸŒŸ GW250114 System Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Health Checks Completed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Workflow status check" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Dependency health check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### System Components" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŒŒ Quantum Validations" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”¬ Alternative Validations" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŒŠ Multi-Event Analysis" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¡ Detector Analysis" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”¬ Scientific Validation" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ§® Advanced Analysis" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”® Special Analysis Methods" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ§ª Comprehensive Testing" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "- [View All Workflows](../../actions)" >> $GITHUB_STEP_SUMMARY
          echo "- [Workflow Intelligence](../../actions/workflows/workflow-intelligence.yml)" >> $GITHUB_STEP_SUMMARY
          echo "- [Production QCAL](../../actions/workflows/production-qcal.yml)" >> $GITHUB_STEP_SUMMARY
